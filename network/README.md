# Network 包

该包实现了 TitanChain 区块链的网络通信、节点管理、消息传输、交易池等核心网络功能。

## 文件说明

### transport.go
定义了网络传输的核心接口和基础类型：
- `NetAddr`: 网络地址类型，标识节点的唯一网络标识。
- `RPC`: 远程过程调用的消息结构，封装网络消息的传递。
- `Transport`: 网络传输接口，定义了节点间通信的基本方法，包括连接、消息收发、广播、地址查询等。
- 主要功能：
  - 支持多种传输层实现（本地、TCP、UDP等）。
  - 统一的节点间通信接口。
  - 便于扩展和测试。
- 典型场景：
  - 作为所有网络传输实现的基础抽象，便于后续扩展多种网络协议。

### local_transport.go
实现了本地网络传输层，便于开发和测试。
- 主要结构：
  - `LocalTransport`：本地传输实现，支持点对点连接、消息发送、超时、最大连接数、线程安全、优雅关闭。
  - `LocalTransportOpts`：本地传输配置选项。
  - `TransportError`：自定义错误类型。
- 主要功能：
  - 建立和断开节点连接。
  - 发送和接收消息（带超时）。
  - 广播消息到所有对等节点。
  - 管理对等节点和连接数。
  - 并发安全和优雅关闭。
  - 节点状态、对等节点列表等接口。
- 典型业务流程：
  - 节点通过 Connect 建立连接，互为对等节点。
  - 通过 SendMessage/Broadcast 实现消息单播和广播。
  - 支持超时、最大连接数、并发安全，适合本地集成测试和模拟网络环境。

### server.go
实现了区块链网络服务器的核心逻辑，负责节点的交易池管理、区块出块、消息处理、广播、与主链集成等。
- 主要结构：
  - `Server`：区块链节点的核心服务，集成交易池、区块链、网络传输、消息通道等。
  - `ServerOpts`：服务器配置选项，支持多传输层、出块时间、私钥、RPC解码与处理器等。
- 主要接口与流程：
  - `NewServer`：创建服务器实例，初始化区块链、交易池、网络通道。
  - `Start`：启动服务器，监听消息通道，分发和处理网络消息。
  - `validatorLoop`：验证者节点定时出块主循环。
  - `ProcessMessage`：统一处理网络消息，分发到交易或区块处理逻辑。
  - `broadcastTx`/`broadcastBlock`：将交易或区块编码后广播到所有节点。
  - `createNewBlock`：打包交易、签名、生成新区块并广播。
  - `processTransaction`：验证并加入交易池，异步广播。
  - `processBlock`：区块入链并广播。
  - `processGetStatusMessage`/`processStatusMessage`：节点状态同步与响应。
  - `initTransports`：多传输层并发消息接收。
- 典型场景：
  - 支持多传输层和优雅关闭，适用于多节点网络环境。
  - 支持验证者节点自动定时出块，适合 PoS/BFT 场景。
  - 支持自定义RPC解码与处理器，便于扩展和测试。
  - 节点间状态同步、区块和交易的高效广播。
  - 与主链、交易池、网络层深度集成，保证区块链网络的高可用性和一致性。
- 详细功能：
  - 节点启动后自动初始化区块链和交易池。
  - 支持多种网络消息类型（交易、区块、状态同步等）。
  - 验证者节点定时打包交易并生成新区块。
  - 所有节点可接收并验证区块、交易消息。
  - 支持节点间状态请求与响应，便于网络自愈和拓扑维护。
  - 支持多传输层并发处理，提升网络吞吐量。
  - 交易池与区块链状态联动，保证交易唯一性和顺序性。
  - 支持优雅关闭和资源回收。

### message.go
定义了网络层节点间状态同步相关的消息结构体：
- `GetStatusMessage`：节点间请求状态的消息结构体，通常用于主动发起状态同步请求，无需携带额外字段。
- `StatusMessage`：节点间返回状态的消息结构体，包含节点ID、版本号、当前区块高度等信息，用于节点间状态同步和健康检查。
- 主要用途：
  - 节点启动、发现、健康检查时的状态同步。
  - 网络层自动发现和自愈。

### rpc.go
实现了网络消息与RPC处理的统一机制，负责消息类型定义、序列化、解码与分发：
- 主要结构与类型：
  - `MessageType`：网络消息类型枚举，区分交易、区块、状态等不同消息。
  - `Message`：网络消息结构体，统一封装消息类型和内容，支持 gob 序列化。
  - `RPC`：远程过程调用消息结构体，统一网络层消息传递格式。
  - `DecodedMessage`：解码后的消息结构体，便于上层处理。
  - `RPCDecodeFunc`/`DefaultRPCDecodeFunc`：RPC消息解码函数类型与默认实现，支持多种消息类型的解码。
  - `RPCProcessor`：RPC处理器接口，定义消息处理方法。
- 主要功能：
  - 网络消息类型的统一标识与扩展。
  - 消息的序列化、反序列化与类型安全传递。
  - 支持自定义消息解码与分发，便于协议扩展。
  - 交易、区块、状态等消息的高效解码与处理。
- 典型业务流程：
  - 节点收到网络消息后，通过 DefaultRPCDecodeFunc 解码为具体类型。
  - 解码后的消息交由 RPCProcessor 统一分发处理。
  - 支持后续扩展更多消息类型和自定义解码逻辑。

### txpool.go
实现了高效的交易池管理。
- 主要结构：
  - `TxPool`：管理所有待处理和待打包的交易，支持最大容量、去重、优先级。
  - `TxSortedMap`：有序哈希映射，支持并发安全的插入、查找、删除。
- 主要接口：
  - `Add`：添加交易，自动去重并按容量裁剪。
  - `Pending`：获取所有待打包交易。
  - `ClearPending`：清空待打包交易。
  - `Contains`：检查交易是否存在。
  - `PendingCount`：获取待打包交易数量。
- 主要功能：
  - 高效的内存交易池管理。
  - 交易去重与优先级裁剪。
  - 并发安全的插入、查找、删除。
  - 批量操作和高效查重。
  - 与网络层、区块打包逻辑集成。

### local_transport_test.go
包含了本地传输实现的单元测试：
- 测试连接建立和断开
- 测试消息发送和接收
- 测试并发操作
- 测试错误处理
- 测试边界条件

### txpool_test.go
交易池相关的单元测试：
- 测试交易池初始化、添加、去重、清空
- 测试交易排序

## 主要功能
- 支持多节点网络通信、消息广播、点对点连接。
- 支持本地和可扩展的传输层实现。
- 支持高效的交易池管理与查重、容量裁剪、并发安全。
- 支持区块和交易的网络广播与同步。
- 支持节点优雅关闭与资源释放。
- 支持并发安全的消息处理。
- 支持多种消息类型和解码机制。
- 支持灵活的网络拓扑和节点扩展。
- 支持服务器自动出块、消息分发、广播等核心区块链网络功能。

## 测试覆盖点
- 交易池的去重、容量裁剪、并发安全。
- 本地传输层的连接、断开、消息收发、广播。
- 服务器的消息处理、出块、广播、优雅关闭。
- RPC消息的序列化、解码、处理。
- 网络异常与超时处理。
- 节点连接管理与断线重连。
- 多节点消息一致性与广播可靠性。

## 后续开发计划

### 近期计划（1-2周）
1. 网络协议扩展
   - 支持更多消息类型（区块、状态同步、节点发现、心跳、错误反馈等）。
   - 优化消息序列化格式（如Protobuf、JSON等多格式支持）。
   - 增强本地传输层的模拟能力，便于集成测试和自动化测试。
   - 完善 message.go/rpc.go 的消息类型体系，支持协议兼容性和灵活扩展。
2. 交易池优化
   - 支持交易优先级、过期机制、批量操作。
   - 增强并发性能与高效查重。
   - 支持多重签名和复杂交易类型。
   - 增强交易池与区块打包、广播机制的联动。
3. 服务器与节点管理
   - 增强服务器的出块调度、消息分发、优雅关闭能力。
   - 节点身份认证与黑名单机制。
   - 节点健康检查、心跳与自动重连。
   - 节点状态监控与动态拓扑调整。
4. 节点间状态同步
   - 完善 GetStatus/Status 消息机制，支持节点自动发现和自愈。
   - 增强节点间区块高度、主链分叉检测与同步能力。
   - 优化消息解码机制，提升协议兼容性和安全性。

### 中期计划（1-2月）
1. P2P网络实现
   - 支持基于TCP/UDP的真实P2P网络。
   - 节点发现、连接管理、消息路由。
   - 网络拓扑优化与分层广播。
2. 网络安全
   - 支持TLS/加密通信。
   - 节点认证与权限控制。
   - 网络攻击防护（如DDoS、Sybil等）。
3. 网络性能
   - 支持高并发消息处理。
   - 网络流量统计与限流。
   - 网络延迟与丢包优化。
4. 区块链与网络协同
   - 优化区块同步、交易同步与状态一致性算法。
   - 支持分布式共识下的高效区块广播。

### 长期计划（3-6月）
1. 跨链与互操作
   - 支持多链互联与跨链消息传递。
   - 网络协议与其他主流区块链兼容。
2. 网络监控与可视化
   - 节点状态监控、消息追踪、网络拓扑可视化。
   - 网络异常自动报警与恢复。
3. 网络模块可插拔
   - 支持多种传输层实现的热插拔。
   - 网络协议与消息格式的可扩展性。
4. 网络与共识深度集成
   - 支持共识层与网络层的事件驱动协作。
   - 优化区块广播与共识消息的高效分发。

## 注意事项
1. 所有新增网络功能需配套单元测试和集成测试。
2. 保持接口抽象与模块解耦，便于后续扩展。
3. 关注网络安全与性能优化。
4. 及时同步文档与开发计划。

## 使用示例

```go
// 创建本地传输实例
transport := NewLocalTransport(LocalTransportOpts{
    Addr:     "node1",
    MaxPeers: 10,
    Timeout:  5 * time.Second,
})

// 创建服务器
server := NewServer(ServerOpts{
    Transports: []Transport{transport},
})

// 启动服务器
server.Start()
```
