# Network 包

该包实现了 TitanChain 区块链的网络通信、节点管理、消息传输、交易池等核心网络功能。

## 文件说明

### transport.go
定义了网络传输的核心接口和基础类型：
- `NetAddr`: 网络地址类型，标识节点的唯一网络标识。
- `RPC`: 远程过程调用的消息结构，封装网络消息的传递。
- `Transport`: 网络传输接口，定义了节点间通信的基本方法，包括连接、消息收发、广播、地址查询等。

### local_transport.go
实现了用于本地测试和开发环境的传输层：
- `LocalTransport`: 本地网络传输的具体实现，支持点对点连接、消息发送、超时、最大连接数、线程安全、优雅关闭等。
- `LocalTransportOpts`: 本地传输配置选项，便于灵活配置节点。
- `TransportError`: 传输层自定义错误类型，便于错误处理和调试。
- 主要功能：
  - 建立和断开节点连接
  - 发送和接收消息（带超时）
  - 广播消息到所有对等节点（Broadcast）
  - 管理对等节点和连接数
  - 支持并发安全和优雅关闭
  - 提供节点状态、对等节点列表等接口

### server.go
实现了区块链网络服务器：
- `Server`：区块链节点的核心服务，负责交易池管理、区块出块、消息处理、广播等。
- 主要结构与接口：
  - `ServerOpts`：服务器配置选项，支持多传输层、出块时间、私钥、RPC解码与处理器等
  - `NewServer(opts ServerOpts)`：创建服务器实例
  - `Start()`：启动服务器并处理消息
  - `ProcessMessage(msg *DecodedMessage)`：处理网络消息，分发到具体逻辑
  - `broadcastTx(tx *core.Transaction)`/`broadcastBlock(b *core.Block)`：广播交易和区块
  - `createNewBlock()`：出块逻辑，打包交易、签名、添加区块
  - `initTransports()`：初始化所有传输层，启动消息监听
- 主要功能：
  - 支持多传输层和优雅关闭
  - 支持验证者节点自动定时出块
  - 支持自定义RPC解码与处理器，便于扩展
  - 并发安全的消息通道与交易池管理
  - 统一的消息分发与处理机制
  - 交易广播与区块广播
  - 与区块链主链、交易池、网络层深度集成

### rpc.go
实现了网络消息与RPC处理：
- `MessageType`: 网络消息类型（交易、区块等）
- `Message`: 网络消息结构体，支持序列化
- `RPC`: 远程过程调用消息结构
- `DecodedMessage`: 解码后的消息结构体，包含发送者和解码内容
- `RPCDecodeFunc`/`DefaultRPCDecodeFunc`: RPC消息解码函数类型与默认实现，支持自定义消息解码逻辑
- `RPCProcessor`: RPC处理器接口，支持统一的消息处理
- 主要功能：
  - 网络消息的类型标识与序列化
  - RPC消息的统一解码与分发
  - 交易消息的解码与处理
  - 支持自定义消息解码与扩展

### txpool.go
实现了高效的交易池：
- `TxPool`：管理所有待处理和待打包的交易，支持最大容量、去重、优先级。
- `TxSortedMap`：有序哈希映射，支持并发安全的插入、查找、删除。
- 主要接口：
  - `Add(tx *core.Transaction)`：添加交易，自动去重并按容量裁剪
  - `Pending() []*core.Transaction`：获取所有待打包交易
  - `ClearPending()`：清空待打包交易
  - `Contains(hash types.Hash)`：检查交易是否存在
  - `PendingCount()`：获取待打包交易数量
- 主要功能：
  - 支持高效的内存交易池管理
  - 交易去重与优先级裁剪
  - 并发安全的插入、查找、删除
  - 支持批量操作和高效查重
  - 便于与网络层、区块打包逻辑集成

### local_transport_test.go
包含了本地传输实现的单元测试：
- 测试连接建立和断开
- 测试消息发送和接收
- 测试并发操作
- 测试错误处理
- 测试边界条件

### txpool_test.go
交易池相关的单元测试：
- 测试交易池初始化、添加、去重、清空
- 测试交易排序

## 主要功能
- 支持多节点网络通信、消息广播、点对点连接。
- 支持本地和可扩展的传输层实现。
- 支持高效的交易池管理与查重、容量裁剪、并发安全。
- 支持区块和交易的网络广播与同步。
- 支持节点优雅关闭与资源释放。
- 支持并发安全的消息处理。
- 支持多种消息类型和解码机制。
- 支持灵活的网络拓扑和节点扩展。
- 支持服务器自动出块、消息分发、广播等核心区块链网络功能。

## 测试覆盖点
- 交易池的去重、容量裁剪、并发安全。
- 本地传输层的连接、断开、消息收发、广播。
- 服务器的消息处理、出块、广播、优雅关闭。
- RPC消息的序列化、解码、处理。
- 网络异常与超时处理。
- 节点连接管理与断线重连。
- 多节点消息一致性与广播可靠性。

## 后续开发计划

### 近期计划（1-2周）
1. 网络协议扩展
   - 支持更多消息类型（区块、状态同步、节点发现、心跳等）。
   - 优化消息序列化格式（如Protobuf、JSON等多格式支持）。
   - 增强本地传输层的模拟能力，便于集成测试和自动化测试。
2. 交易池优化
   - 支持交易优先级、过期机制、批量操作。
   - 增强并发性能与高效查重。
   - 支持多重签名和复杂交易类型。
   - 增强交易池与区块打包、广播机制的联动。
3. 服务器与节点管理
   - 增强服务器的出块调度、消息分发、优雅关闭能力。
   - 节点身份认证与黑名单机制。
   - 节点健康检查、心跳与自动重连。
   - 节点状态监控与动态拓扑调整。

### 中期计划（1-2月）
1. P2P网络实现
   - 支持基于TCP/UDP的真实P2P网络。
   - 节点发现、连接管理、消息路由。
   - 网络拓扑优化与分层广播。
2. 网络安全
   - 支持TLS/加密通信。
   - 节点认证与权限控制。
   - 网络攻击防护（如DDoS、Sybil等）。
3. 网络性能
   - 支持高并发消息处理。
   - 网络流量统计与限流。
   - 网络延迟与丢包优化。

### 长期计划（3-6月）
1. 跨链与互操作
   - 支持多链互联与跨链消息传递。
   - 网络协议与其他主流区块链兼容。
2. 网络监控与可视化
   - 节点状态监控、消息追踪、网络拓扑可视化。
   - 网络异常自动报警与恢复。
3. 网络模块可插拔
   - 支持多种传输层实现的热插拔。
   - 网络协议与消息格式的可扩展性。

## 注意事项
1. 所有新增网络功能需配套单元测试和集成测试。
2. 保持接口抽象与模块解耦，便于后续扩展。
3. 关注网络安全与性能优化。
4. 及时同步文档与开发计划。

## 使用示例

```go
// 创建本地传输实例
transport := NewLocalTransport(LocalTransportOpts{
    Addr:     "node1",
    MaxPeers: 10,
    Timeout:  5 * time.Second,
})

// 创建服务器
server := NewServer(ServerOpts{
    Transports: []Transport{transport},
})

// 启动服务器
server.Start()
```
