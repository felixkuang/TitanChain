# Network 包

这个包实现了 TitanChain 区块链的网络通信层，提供了节点间通信的基础设施。

## 文件说明

### transport.go
定义了网络传输的核心接口和基础类型：
- `NetAddr`: 网络地址类型
- `RPC`: 远程过程调用的消息结构
- `Transport`: 网络传输接口，定义了节点间通信的基本方法

### local_transport.go
实现了用于本地测试和开发环境的传输层：
- `LocalTransport`: 本地网络传输的具体实现，支持点对点连接、消息发送、超时、最大连接数、线程安全、优雅关闭等
- `LocalTransportOpts`: 本地传输配置选项
- `TransportError`: 传输层自定义错误类型
- 主要功能：
  - 建立和断开节点连接
  - 发送和接收消息（带超时）
  - 管理对等节点和连接数
  - 支持并发安全和优雅关闭
  - 提供节点状态、对等节点列表等接口

### server.go
实现了区块链网络服务器：
- `Server`: 网络服务器的核心实现
- 功能特性：
  - 支持多传输层
  - 异步消息处理
  - 定时任务执行
  - 优雅关闭机制
  - 支持自定义RPC解码函数（`RPCDecodeFunc`）和处理器（`RPCProcessor`）
  - 统一的消息分发与处理机制
  - 交易广播与交易池管理
- 主要职责：
  - 初始化传输层
  - 处理网络消息（支持自定义解码与分发）
  - 管理服务生命周期
  - 管理内存交易池
  - 处理和广播交易消息

### rpc.go
实现了网络消息与RPC处理：
- `MessageType`: 网络消息类型（交易、区块等）
- `Message`: 网络消息结构体，支持序列化
- `RPC`: 远程过程调用消息结构
- `DecodedMessage`: 解码后的消息结构体，包含发送者和解码内容
- `RPCDecodeFunc`/`DefaultRPCDecodeFunc`: RPC消息解码函数类型与默认实现，支持自定义消息解码逻辑
- `RPCProcessor`: RPC处理器接口，支持统一的消息处理
- 主要功能：
  - 网络消息的类型标识与序列化
  - RPC消息的统一解码与分发
  - 交易消息的解码与处理
  - 支持自定义消息解码与扩展

### txpool.go
实现了内存交易池：
- `TxPool`: 交易池结构，支持交易的添加、去重、排序、清空等操作
- `TxMapSorter`: 交易排序器，按 firstSeen 字段排序
- 主要功能：
  - 交易池管理
  - 交易优先级排序
  - 并发安全

### local_transport_test.go
包含了本地传输实现的单元测试：
- 测试连接建立和断开
- 测试消息发送和接收
- 测试并发操作
- 测试错误处理
- 测试边界条件

### txpool_test.go
交易池相关的单元测试：
- 测试交易池初始化、添加、去重、清空
- 测试交易排序

## 核心功能

### 网络通信
- 支持点对点通信
- 异步消息处理
- 可靠的消息传递
- 超时机制

### 节点管理
- 动态节点发现
- 连接数限制
- 节点状态监控
- 连接生命周期管理

### 交易池管理
- 支持高效的内存交易池
- 交易优先级排序
- 并发安全

### RPC与消息处理
- 支持多类型网络消息（交易、区块等）
- 统一的RPC消息分发与处理
- 可扩展的消息处理器接口
- 支持自定义消息解码与分发逻辑
- 支持解码后消息结构体（DecodedMessage）统一处理

### 交易广播
- 支持交易的自动广播与去重
- 交易首次见到时间戳管理
- 交易池与网络层联动

### 错误处理
- 自定义错误类型
- 超时处理
- 连接错误处理
- 优雅降级

## 使用示例

```go
// 创建本地传输实例
transport := NewLocalTransport(LocalTransportOpts{
    Addr:     "node1",
    MaxPeers: 10,
    Timeout:  5 * time.Second,
})

// 创建服务器
server := NewServer(ServerOpts{
    Transports: []Transport{transport},
})

// 启动服务器
server.Start()
```

## 后续开发计划
### 近期计划（1-2周）
1. 添加 TCP/UDP 传输实现，支持真实网络环境
2. 实现节点发现与自动连接机制
3. 支持消息加密和认证，提升安全性
4. 优化交易池并发性能和内存管理
5. 增强网络监控、统计与日志
6. 丰富RPC消息类型，支持区块、共识等更多消息
7. 支持自定义消息分发与处理插件
8. 丰富消息解码与扩展机制，支持多类型消息统一处理

### 中期计划（1-2月）
1. 实现 P2P 网络拓扑与分层路由，提升扩展性
2. 支持跨链通信协议，兼容多链生态
3. 网络层与共识层深度集成，支持共识消息高效传递
4. 交易池与区块链状态联动，提升一致性和性能
5. 支持多种消息序列化格式（如Protobuf）
6. 支持多种消息类型的高效广播与订阅

### 长期计划（3-6月）
1. 网络层安全加固（抗DDoS、抗Sybil、抗重放攻击等）
2. 网络协议升级与兼容性支持（如多版本、热升级）
3. 网络层性能极致优化（高并发、低延迟、分片等）
4. 支持多种网络环境（NAT、IPv6、移动网络等）
5. 网络层与隐私保护、合规审计等高级功能集成