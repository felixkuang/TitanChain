# TitanChain Core 包说明文档

## 文件结构说明

### block.go
实现了区块链中区块的核心数据结构和相关功能：
- `Header`: 区块头结构，包含版本号、数据哈希、前块哈希、高度和时间戳
- `Block`: 完整区块结构，包含区块头、交易列表（指针切片）、验证者公钥和签名
- 主要功能：
  - 区块创建（`NewBlock`、`NewBlockFromPrevHeader`，交易列表类型为`[]*Transaction`）
  - 区块签名与验证
  - 区块编码/解码
  - 区块哈希计算
  - 交易添加（`AddTransaction`，支持指针类型）
  - 交易数据哈希计算（`CalculateDataHash`，支持指针类型）

### blockchain.go
实现了区块链的核心功能：
- `Blockchain`: 区块链结构，管理区块的存储和验证
- 主要功能：
  - 区块链初始化
  - 区块添加和验证
  - 区块高度与区块头查询
  - 验证器管理

### transaction.go
实现了交易相关的数据结构和功能：
- `Transaction`: 交易结构，包含数据、公钥、签名、哈希
- 主要功能：
  - 交易签名与验证
  - 交易哈希计算（带缓存）
  - 交易序列化与反序列化

### validator.go
实现了区块验证相关的功能：
- `Validator`: 验证器接口定义
- `BlockValidator`: 基本的区块验证器实现
- 主要功能：
  - 区块高度验证
  - 前区块哈希验证
  - 区块签名验证
  - 可扩展的验证规则框架

### storage.go
实现了区块存储相关的功能：
- `Storage`: 存储接口定义
- `MemoryStore`: 基于内存的存储实现
- 主要功能：
  - 区块存储接口抽象
  - 内存存储的基本实现

### encoding.go
实现了 TitanChain 核心的数据序列化与反序列化机制，支持区块和交易的高效二进制编解码。

#### 主要结构与接口
- `Encoder`/`Decoder`：通用泛型接口，定义了任意类型数据的编码与解码方法，便于扩展多种序列化格式。
- `GobTxEncoder`/`GobTxDecoder`：基于 gob 的交易编码器/解码器，实现 `Encode`/`Decode` 方法，支持将 `Transaction` 结构高效序列化为二进制流，或从二进制流反序列化为交易对象。
- `GobBlockEncoder`/`GobBlockDecoder`：基于 gob 的区块编码器/解码器，实现区块的高效二进制序列化与反序列化，便于区块在网络中的传输和本地持久化。

#### 主要功能
- 交易和区块的 gob 编码与解码，支持高效的网络传输和存储。
- 通用接口设计，便于未来扩展 Protobuf、JSON 等多种序列化格式。
- 支持自定义类型注册（如椭圆曲线参数），保证 gob 编解码的兼容性。
- 代码结构清晰，便于后续维护和扩展。

#### 使用示例
```go
// 交易编码
enc := core.NewGobTxEncoder(writer)
err := enc.Encode(tx)

// 区块解码
dec := core.NewGobBlockDecoder(reader)
err := dec.Decode(block)
```

### hasher.go
实现了哈希计算相关的功能：
- `Hasher`: 通用哈希计算接口
- `BlockHasher`: 区块头哈希计算（SHA256）
- `TxHasher`: 交易哈希计算（SHA256）
- 主要功能：
  - 区块头和交易的哈希计算
  - 支持自定义哈希器

### block_test.go
区块相关的单元测试：
- 测试区块签名与验证
- 辅助生成随机区块

### blockchain_test.go
区块链核心功能的单元测试：
- 测试区块批量添加、区块高度、区块头获取、分叉与跳跃高度等场景
- 辅助函数生成带创世区块的链和前区块哈希

### transaction_test.go
交易相关的单元测试：
- 测试交易签名与验证
- 测试交易序列化与反序列化
- 辅助生成带签名的交易

### vm.go
实现了 TitanChain 的轻量级虚拟机（VM），用于执行简单的字节码指令，为后续智能合约和脚本执行提供基础：
- `Instruction`：虚拟机支持的指令类型，目前包括数据入栈（InstrPush）、加法（InstrAdd）、单字节入栈（InstrPushByte）、字节打包（InstrPack）、减法（InstrSub）等。
- `Stack`：虚拟机的操作数栈，支持任意类型元素的入栈（Push）和出栈（Pop）操作，底层为切片实现，支持动态扩展。
  - `Push(v any)`：将任意类型元素压入栈顶。
  - `Pop() any`：弹出栈顶元素并返回。
- `VM`：虚拟机结构体，包含字节码数据、指令指针、操作数栈等。
  - `Run()`：顺序执行字节码指令，直到结束或遇到错误。
  - `Exec(instr Instruction)`：执行单条指令，根据类型完成入栈、加法、减法、打包等操作。
- 指令集设计具备良好扩展性，便于后续增加乘法、除法、条件跳转、存储访问等高级指令。

#### 主要功能
- 支持基础的算术运算和数据操作，为智能合约和链上脚本系统奠定基础。
- 结构清晰，便于后续扩展指令集和集成 Gas 计量、错误处理等机制。
- 通过 Stack 结构体实现高效的操作数管理，支持任意类型数据。

#### 设计理念
- 参考以太坊 EVM 的栈式虚拟机模型，采用简洁的指令集和操作数栈，便于并发执行和安全隔离。
- 预留指令扩展接口，支持未来复杂合约和脚本的执行需求。
- 代码注释详细，便于开发者理解和二次开发。

### vm_test.go
虚拟机相关的单元测试：
- 测试字节码指令的基本执行流程（如数据入栈、加法）
- 验证虚拟机执行结果的正确性

### state.go
实现了 TitanChain 的基础状态管理模块，负责链上账户、合约等数据的存储与访问：
- `State`：内存型状态存储结构体，底层为 map[string][]byte。
  - `NewState()`：创建新的状态存储实例。
  - `Put(k, v []byte)`：写入一对键值。
  - `Get(k []byte)`：根据键获取值，若不存在返回错误。
  - `Delete(k []byte)`：删除指定键。
- 设计简洁，便于后续扩展为持久化存储（如 LevelDB/BadgerDB）、支持快照、回滚、状态压缩等高级功能。

#### 主要功能
- 支持链上账户、合约等任意数据的高效存取。
- 提供简单的接口，便于与虚拟机、区块链主流程集成。
- 便于单元测试和功能验证。

#### 设计理念
- 采用 map 实现，保证开发初期的高效与灵活。
- 预留接口扩展，便于未来接入持久化存储、状态快照、MPT 等。
- 代码注释详细，便于开发者理解和二次开发。

## 完整功能说明
- 支持区块和交易的签名与验证，保证数据完整性和不可抵赖性
- 支持区块链的高度、区块头、区块添加、分叉检测等核心操作
- 支持区块存储接口抽象，便于后续扩展持久化存储
- 支持区块和交易的单元测试，保证核心逻辑正确性
- 支持交易的高效序列化、哈希、优先级管理
- 代码结构清晰，便于后续模块化扩展
- 支持轻量级虚拟机的字节码执行，为智能合约和脚本系统奠定基础，具备良好扩展性。
- 支持链上状态的高效存储、读取与删除，为账户、合约、链上数据管理提供基础能力。

## 测试覆盖点
- 区块签名与验证的正确性
- 区块链批量添加、分叉、跳跃高度等边界场景
- 交易签名、验证、序列化与反序列化
- 存储接口的抽象与内存实现
- 哈希与编码器的正确性
- 虚拟机指令执行的正确性

## 后续开发计划

### 近期计划（1-2周）
1. 完善区块结构
   - 支持区块内交易的并行验证与执行
   - 优化区块头与数据哈希的计算逻辑，适配指针类型交易列表
   - 增强区块签名与多重签名支持
2. 完善存储系统
   - 实现持久化存储（如LevelDB/BadgerDB）
   - 添加区块索引与高效查询
   - 实现区块缓存机制
   - 状态管理扩展：
     - 设计 State 接口，支持多种存储后端（内存、LevelDB、BadgerDB）
     - 实现状态快照与回滚机制，便于合约执行和链重组
     - 预研 Merkle Patricia Trie（MPT）集成，提升安全性和可验证性
     - 状态压缩与高效存储优化
3. 增强验证系统
   - 添加更多交易验证规则
   - 实现区块时间戳、大小、双花检测等
   - 支持多种共识规则的验证器
4. 区块链核心优化
   - 实现分叉处理与区块回滚
   - 优化区块同步与孤儿块处理
5. 交易与序列化
   - 支持多种编码格式（如Protobuf、JSON），实现与 gob 的兼容与切换
   - 优化交易池与区块打包逻辑
   - 增强交易哈希缓存与高效查重机制
   - 评估和优化 gob 编解码性能，逐步引入更高效的序列化方案
6. 虚拟机（VM）功能完善
   - 增加更多基础指令（如乘法、除法、条件跳转、存储访问等）
   - 实现 Gas 计量机制，防止死循环
   - 完善错误处理和边界检查
   - 增加指令单元测试
   - 设计合约调用栈和上下文隔离机制
   - 预研多语言合约支持和高性能执行引擎集成

### 中期计划（1-2月）
1. 共识机制
   - 实现PoS/BFT等共识
   - 验证者管理与惩罚机制
   - 质押与投票功能
2. 状态管理
   - 实现Merkle Patricia Trie
   - 状态快照与回滚
   - 状态压缩与高效存储
3. 网络层
   - 实现P2P通信、节点发现、区块/交易广播
   - 网络同步优化
   - 支持多格式消息序列化（如 Protobuf、JSON、gob 等），提升网络兼容性和性能
4. 智能合约与虚拟机集成
   - 支持合约部署、调用与状态管理
   - 实现合约调用栈和上下文隔离
   - 支持合约事件与日志

### 长期计划（3-6月）
1. 智能合约
   - 实现VM、合约部署与执行、Gas计费
   - 合约升级与权限管理
2. 性能优化
   - 并行交易处理、分片、缓存层
   - 存储与网络性能提升
   - 序列化机制的持续优化，支持自定义高性能二进制协议
3. 安全性增强
   - 多种加密算法、权限控制、数据隐私保护
   - 审计与安全监控
   - 增强模块化与可插拔性
4. 虚拟机与主链深度集成
   - 支持合约权限管理、升级与安全审计
   - 引入多语言合约支持和更高效的执行引擎

## 注意事项
1. 所有新增代码必须包含完整的单元测试
2. 保持代码风格一致，遵循Go的编码规范
3. 确保向后兼容性
4. 及时更新文档
5. 关注性能优化
6. 重视安全性设计 